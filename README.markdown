# Zephyr Watch 1

**Zephyr Watch 1** — DIY-проект смарт-часов на базе микроконтроллера **ESP32-S3-Zero-N4R2**, вдохновлённый **Google Pixel Watch 3** с Wear OS 6 (Android 16). Цель — создать кастомные часы с уникальным корпусом и функциональностью, близкой к Wear OS: стильный интерфейс в духе **Material You 3**, watchfaces, уведомления, энергоэффективность на Li-ion батарее 400mAh. Прошивка построена на **ESP-IDF v5.3+** с библиотекой **LVGL v9+** для UI.

## Цели проекта
Создать кастомные смарт-часы с:
- **Дисплеями ST7789 или ssd1306**: Первый цветной (240x240, SPI, шлейфовые с переходником на пины, сенсор XPT2046) а второй обычный чёрно/белый. Прошивка определяет подключённые дисплеи и адаптирует UI (Material You 3, watchfaces, анимации).
- **Адаптивный UI**: Интерфейс в стиле Material You 3 (rounded cards, dynamic colors, плавные анимации), оптимизированный под цветные дисплеи ST7789.
- **Взаимодействие**:
  - Основное: Ротационный энкодер с кнопкой и трещоткой (KY-040 или аналог) для скролла меню и выбора.
  - Дополнительное: Сенсорный ввод (XPT2046) на ST7789 для тапов/свайпов и уповление энкодером для ssd1306.
- **Магнитная зарядка**: Модуль TP4056 с магнитными контактами (V+/GND, pogo-pin или площадки). Данные по пинам не передаются (ESP-NOW для связи).
- **SD-карта**: Хранение пользовательских данных в /sdcard (до 32GB).
- **Энергоэффективность**: Deep sleep (~0.01-0.05mah), пробуждение по кнопке/энкодеру/сенсору.

## Аппаратное обеспечение
- **Микроконтроллер**: ESP32-S3-Zero-N4R2 (4MB Flash, 2MB PSRAM, WiFi/BLE).
- **Дисплеи**:
  - **SSD1306** (128x64)
  - **ST7789** (240x240, SPI, шлейф с переходником, пины: GPIO18/SCLK, GPIO23/MOSI, GPIO17/DC, GPIO16/CS, GPIO5/RES; сенсор XPT2046 на GPIO15/TOUCH_CS).
- **Ротационный энкодер**: KY-040 с кнопкой и трещоткой (пины: GPIO4/CLK, GPIO2/DT, GPIO1/SW, 3.3V, GND, pull-up резисторы 10kΩ).
- **Зарядка**: TP4056 (Li-ion 400mAh, IN+/IN- через магнитные контакты, BAT+ через диод Шоттки 1N5819 к 5V ESP32, OUT+ через второй диод для load-sharing).
- **SD-ридер** (опционально): SPI (пины: GPIO9/CS, GPIO11/MOSI, GPIO12/MISO, GPIO10/SCK, 3.3V, GND).
- **Корпус**: Кастомный, переделанный от детских часов, с вырезами под дисплеи, энкодер и магнитные контакты. Внешний вид уникальный, но функционал эмулирует Pixel Watch 3.

### Схема подключений
```
[USB Charger] -- [Mag1:V+] -- TP4056(IN+) -- BAT+ -- [Li-ion +] -- 1N5819(A) -- 5V [ESP32]
                   |                    |                        |
[Mag2:GND] -- IN- -- BAT- -- [Li-ion -] -- GND [ESP32]
                   |                    |
                   OUT+ -- 1N5819(A) -- 5V [ESP32]

ESP32-S3-Zero:
- GPIO18,23,17,16,5 -- [ST7789: SCLK, MOSI, DC, CS, RES]
- GPIO15 -- TOUCH_CS [XPT2046]
- GPIO4 -- CLK [Encoder]
- GPIO2 -- DT [Encoder]
- GPIO1 -- SW [Encoder]
- GPIO9-12 -- [SD: CS, MOSI, MISO, SCK]
```

## Программное обеспечение
- **Фреймворк**: ESP-IDF v5.3+ (espressif.com).
- **UI**: LVGL v9+ для рендеринга. Адаптация:
  - Определяет подключённые ST7789 (SPI init для каждого).
  - Рендерит Material You 3 UI (dynamic colors, rounded cards, анимации) на активном дисплее (или обоих, если оба подключены).
  - Поддерживает сенсорный ввод (XPT2046) для тапов/свайпов.
- **Взаимодействие**:
  - **Энкодер**: Скролл меню/watchfaces (CW/CCW с трещоткой), выбор (нажатие кнопки).
  - **Сенсор**: Тапы/свайпы для выбора или навигации (опционально, если активен ST7789).
- **Файловая система**:
  - **карта памяти - FAT32** (MIN 512MB - 32GB MAX): /system (**~200KB**), /boot(**64KB**), /tmp (**4KB**), /vendor (**~200KB**), /sdcard (**~**).


### Упрощённая файловая система
Эмулирует Wear OS 6 FS:
- **/** (32GB): Сдесь и будут разделы ввиде папок ссылок (/boot, /system и т.д)
- **/system** (~340KB): UI, конфиги, watchfaces (e.g., /system/fonts/Android.json).
- **/boot** (max 64KB): Анимация запуска (/boot/bootanimation.json или .bin для LVGL), OTA-метаданные.
- **/sdcard** (max 32GB, SD): Пользовательские данные (логи, настройки, и т.д).
- **/tmp** (~4KB): Логи (энкодер, сенсор, батарея, и т.д).
- **/vendor** (~200KB): Конфиги и драйвера hardware (ST7789, XPT2046, энкодер и т.д).
- **/dev** (~): Устрйстава
- **init.rc**: Реализован как `android` (инициализация FS, дисплеев, ввода/вывода и т.д).

**Пример структуры:**
```
/
├── system
│   └── /fonts/android.json (Material You 3: colors, cards)
├── boot
│   └── bootanimation.json (анимация: "Zephyr Boot")
├── tmp
│   └── all_log.json (логи: menu_pos, touch)
├── vendor
│   └── wlan/xtensa-esp32s3-elf.h
/sdcard
└── app/launcher.app
```

**Структура сейчас**
```
.
├── boot
│   ├── bootanimation.h
│   └── initrc.c
├── dev
├── init.c
├── partitions.csv
├── sdcard
├── system
│   ├── app
│   ├── bin
│   ├── fonts
│   └── lib
├── tmp
└── vendor

```

## Визуальный стиль и взаимодействие
- **UI (Material You 3)**:
  - **ST7789**: Полноцветный UI (primary color #2196F3, accent #4CAF50), rounded cards (radius=12), shadows (elevation=4), fade-in анимации.
  - **Адаптация**: LVGL layouts (flex/grid) масштабируются под 240x240. Если оба дисплея активны, UI рендерится синхронно или переключается по энкодеру.
  - **Watchfaces**: Время, уведомления, шаги. Загружаются из /system/ui.json.
  - **Меню**: lv_list с карточками, скролл через энкодер или свайпы (сенсор).
- **Взаимодействие**:
  - **Энкодер**: Вращение (CW/CCW с трещоткой) для скролла меню/watchfaces, нажатие кнопки — выбор или запрос UI с N16R8.
  - **Сенсор** (XPT2046): Тапы для выбора, свайпы для меню (на ST7789, если активны).
  - **Анимация запуска**: Из /boot/bootanimation.json (LVGL-анимация: текст или графика для ST7789 типо .bin).
- **Дисплеи**: Прошивка проверяет SPI (GPIO16/26 для CS) и инициализирует подключённые ST7789/ssd1306. Один или оба могут быть активны.

## Реализация
- **ESP32-S3-Zero (часы)**: Прошивка в `Zephyr_Watch/firmware/`:
  - **Инициализация**: Проверяет ST7789 (SPI init) или i2c для ssd1306, сенсоры (XPT2046), монтирует FAT32 (/system, /boot, /tmp, /vendor, /dev, /sdcard) и SD (/sdcard), инициализирует энкодер, ESP-NOW.
  - **UI**: LVGL рендерит Material You 3 UI на активном ST7789 (или обоих).
  - **Deep sleep**: Через 10 сек бездействия, пробуждение по кнопке/энкодеру/сенсору.



## Зависимости
- arduino ide
- ESP-IDF v5.3+ (espressif.com)
- LVGL v9+ (github.com/lvgl/lvgl)
- ArduinoJson (для UI парсинга, опционально)
- Fritzing/KiCad для схемы (опционально)
